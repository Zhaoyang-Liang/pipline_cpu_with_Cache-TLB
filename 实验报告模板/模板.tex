\documentclass[a4paper]{article}
\input{style/ch_xelatex.tex}
\input{style/scala.tex}
\renewcommand {\thefigure}{\thesection{}.\arabic{figure}}%图片按章标号


% 代码样式设置（Verilog）
\lstdefinelanguage{Verilog}{
    morekeywords={module, endmodule, input, output, wire, reg, always, assign, if, else, begin, end, posedge, negedge, parameter, localparam, case, default},
    sensitive=true,
    morecomment=[l]{//},
    morecomment=[n]{/*}{*/},
    morestring=[b]"
}

\lstset{
    language=Verilog,
    basicstyle=\ttfamily\small,
    keywordstyle=\color{blue}\bfseries,
    commentstyle=\color{dkgreen},
    stringstyle=\color{red},
    numbers=left,
    numberstyle=\tiny\color{gray},
    stepnumber=1,
    numbersep=5pt,
    backgroundcolor=\color{gray!10},
    frame=single,
    breaklines=true,
    breakatwhitespace=true,
    tabsize=4,
    showspaces=false,
    showstringspaces=false
}

\usepackage{booktabs}
\usepackage{geometry}
\geometry{left=2.5cm,right=2.5cm,top=3cm,bottom=3cm}

\begin{document}

\renewcommand{\figurename}{图}
\renewcommand{\contentsname}{目录}  
\cfoot{\thepage\ of \pageref{LastPage}}
\renewcommand{\abstractname}{\textbf{\Large 摘要}} 

\begin{center}
    \huge{\textbf{TLB Cache AXI总线的五级流水CPU}}
\end{center}

\begin{center}
    \textbf{姓名}：\underline{梁朝阳 2311561} \quad
    \textbf{专业}：\underline{密码科学与技术}
\end{center}

\tableofcontents

\vspace*{1cm}

\noindent{\Large\textbf{摘要}}

\vspace{1em}


\vspace{1em}
\noindent\textbf{关键词：} MIPS、五级流水线、CP0、异常处理、中断、协处理器

\newpage


\section{实验要求}

在现有的五级流水线CPU的基础上，增加TLB模块和cache模块。

\begin{enumerate}
    \item 本次实验是学期末综合实验，主要考察大家对TLB和cache的理解和应用，大家根据自己的能力和时间往后做即可，不强制要去全部功能都做出来。
    \item TLB部分推荐完成TLB模块设计和TLB相关指令和CP0寄存器部分，例外支持部分大家自己把握。
    \item Cache部分至少设计出ICache和DCache，并尝试在CPU中集成测试，其他部分大家自己把握。
\end{enumerate}


\section{CPU全局设计图}

\newpage

\section{实验原理与设计}

\subsection{TLB模块}

\subsubsection{TLB参数设计}
设计采用全相联TLB，表项数为4。页大小固定为4KB（\textbf{VPN=addr[31:12]，offset=addr[11:0]}），每条表项包含VPN、PPN、valid、dirty位。采用固定映射（PPN=VPN）并在复位/首次时钟初始化valid/dirty为1，保证基本访问稳定可用。异常编码支持TLBL/TLBS/Modify，优先级为miss/invalid优先于modify。下图\ref{fig:TLB地址转换}主要是展示了一个地址转换的过程，左侧的TLB比较简单，就没有单独再绘制一个TLB的结构图了。（但是下面画了一个Cache的结构图）。


\begin{figure}[H]
    \centering
    \includegraphics[width=\linewidth]{img/TLB地址转换.png}
    \caption{TLB地址转换(设计图)}
    \label{fig:TLB地址转换}
\end{figure}

TLB（Translation Lookaside Buffer）用于加速虚拟地址到物理地址的转换。流水线访存时先用虚拟页号（VPN）在TLB中查找，如果命中则得到物理页号（PPN）并拼接页内偏移形成物理地址；若未命中或表项无效则触发TLB相关异常。



\paragraph{加了TLB后的一大改变}
之前的AXI接到的mem我只写了为256个word。实际访问时仅使用地址低位作为索引，高位地址会发生回绕（alias），因此逻辑地址范围大于物理存储容量时会映射到同一片存储区域。（简单来说就是直接把高位扔了，现在TLB可以在某种意义上实现一个简单的地址转换）。


\newpage


\subsection{Cache模块}


\subsection{I/D-Cache 参数设计}

两个cache虽然公能有区别，但是结构类似（设计的参数）：

共同点是直映结构、4 行、16B 行大小（byte offset = addr[1:0]， word offset = addr[3:2]，index = addr[5:4]，tag = addr[31:6]）



\begin{figure}[H]
    \centering
    \includegraphics[width=\linewidth]{img/一路.png}
    \caption{直接映射Cache结构设计图}
\end{figure}

具体到每个Cache的具体实现区别：

\begin{enumerate}
    \item I-Cache采用直映结构，4行，行大小16B（4个word）。索引为addr[5:4]，标记为addr[31:6]，字偏移为addr[3:2]。miss时发起burst长度4的AXI读事务，填充后更新tag与valid。接口采用req/resp握手，支持流水暂停等待。
    \item D-Cache采用直映结构，4行，行大小16B（4个word），索引与标记划分同I-Cache。写策略为写直达+写分配：store未命中先refill，再更新cache行并发起单次AXI写；load未命中则refill后返回数据。支持字/字节访问，字节写通过读-改-写合并实现，LB/LBU按符号/无符号扩展返回。
\end{enumerate}






\subsubsection{I/D-Cache区别}

I-Cache仅服务取指路径，属于只读缓存。取指地址先在I-Cache中查找，命中则直接返回指令；未命中则触发一次行填充（refill），从指令存储器按cache行大小进行burst读入，再返回所需指令。由于取指不涉及写操作，I-Cache不需要脏位与写回策略，实现更简单、时序更稳定。


D-Cache用于数据访存，支持读写操作。对load命中直接返回数据；对store命中先更新cache行，再根据写策略写到主存。未命中时需要行填充，之后再完成当前读/写。为了简化教学实现，本设计采用直映结构与写直达策略，避免复杂的替换与写回。总结可以为：





\begin{enumerate}
    \item I‑Cache 只读，只做取指；不需要写策略、字节合并、写直达
    \item D‑Cache 读写都要处理，包含写直达、写分配、LB/LBU/SB 的字节处理
\end{enumerate}

\section{实验结果}

\section{实验总结}
\label{LastPage}

\end{document}
